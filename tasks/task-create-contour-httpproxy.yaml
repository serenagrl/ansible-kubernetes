- name: Check for root HTTPProxy availability
  kubernetes.core.k8s_info:
    kind: HTTPProxy
    name: root-httpproxy
    namespace: projectcontour
  register: httpproxy  

- block:
    - name: Create HTTPProxy
      kubernetes.core.k8s:
        definition: |
          {{ httpproxy_definition }}

    - name: Patch root HTTPProxy
      kubernetes.core.k8s:
        state: patched
        namespace: projectcontour
        kind: HTTPProxy
        name: root-httpproxy
        definition: |
          spec:
            includes:
              - name: {{ name }}
                namespace: {{ namespace }}
  when:
    - (httpproxy.resources | length > 0)  