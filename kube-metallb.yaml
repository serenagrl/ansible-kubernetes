# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- name: <<<<< Install and configure MetalLB >>>>>
  hosts: kubernetes_control_planes[0]
  become_user: "{{ _kube.user }}"

  vars:
    manifest_file: "{{ _work_dir }}/metallb.yaml"
    
  tasks:
    - import_tasks: ./tasks/task-get-manifest.yaml
      become_user: root
      vars:
        name: "metallb"
        repo_path: "metallb/metallb"
        pkg_version: "{{ _pkg.metallb | default }}"
        version_prefix: "v"
        dest: "{{ manifest_file }}"
        urls: ["https://raw.githubusercontent.com/{{ repo_path }}/{{ release }}/config/manifests/metallb-native.yaml"]
      delegate_to: localhost

    - name: Installing metallb
      kubernetes.core.k8s:
        state: present
        apply: yes
        force: yes
        definition: "{{ lookup('file', manifest_file) | from_yaml_all }}"

    - name: Waiting for metallb-system to be ready
      shell: kubectl rollout status -n metallb-system deployment/controller

    - name: Cleanup manifest file
      become_user: root
      file:
        path: "{{ manifest_file }}"
        state: absent
      delegate_to: localhost

    - name: Configure address pool 
      kubernetes.core.k8s:
        apply: yes
        force: yes
        definition: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: address-pool
            namespace: metallb-system
          spec:
            addresses: {{ _metallb.addresses }} 

    - name: Configure layer 2 advertisement
      kubernetes.core.k8s:
        apply: yes
        force: yes
        definition: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: address-advertisement
            namespace: metallb-system
          spec:
            ipAddressPools:
              - address-pool
