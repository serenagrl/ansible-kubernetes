- delegate_to: "{{ item }}"
  become_user: root
  block:
    - name: Create a containerd certificate directory (if not exist)
      ansible.builtin.file:
        path: "{{ CR_CERT_DIR }}"
        state: directory
        mode: '0755'

    - name: Copy registry certificate to containerd certificate directory
      ansible.builtin.copy:
        src: "{{ CERT_FILE }}"
        dest: "{{ CR_CERT_DIR }}/harbor-ca.crt"
        mode: 0777

    - name: Configure kubernetes nodes to trust registry certificate
      ansible.builtin.include_tasks: "{{ ansible_distribution | lower }}/trust-cert.yaml"

  ignore_errors: yes
  ignore_unreachable: yes