- delegate_to: "{{ item }}"
  become_user: root
  block:
    - name: Installing nfs client package
      ansible.builtin.apt:
        pkg:
          - nfs-common
        state: latest
        update_cache: true
      
    - name: Export shared directory to kubernetes cluster nodes
      delegate_to: nfs_server
      become_user: root
      ansible.builtin.shell: |
        (
            flock -x 9

            cat /etc/exports | grep "{{ csi_nfs.shared }} {{ hostvars[item].ansible_host }}"
            if [ $? -eq 1 ]
            then
              echo "{{ csi_nfs.shared }} {{ hostvars[item].ansible_host }}(rw,no_subtree_check,no_root_squash)" >> /etc/exports
            fi
            sudo exportfs -ar
        ) 9>/tmp/nfs.lock