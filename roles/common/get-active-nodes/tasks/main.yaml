- name: Get active nodes in kubernetes cluster
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: nodes_info

- name: Set active hosts list to fact
  vars:
    active_nodes: "{{ nodes_info.resources | map(attribute='status') | map(attribute='addresses') | community.general.json_query('[*][?type==`Hostname`].address') | map('join', '') }}"
  ansible.builtin.set_fact:
    fact_active_hosts: "{{ groups['kubernetes_cluster'] | map('extract', hostvars) | selectattr('ansible_hostname', 'in', active_nodes | string) | map(attribute='inventory_hostname') }}"