# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

- delegate_to: "{{ item }}"
  become_user: root
  vars:
    config: "{{ haproxy_config_file['content'] | b64decode }}"
    regex: '^\s*(backend {{ _kube.cluster.name }}-ingress-https-backend.*\n(?:^.+\n)*)$'
    is_exist: "{{ config | regex_search(regex, multiline=True) }}"
    action: "{{ is_exist | ternary('update', 'create') }}"
  block:
    - name: Get haproxy config file from HAProxy load-balancer
      slurp:
        src: /etc/haproxy/haproxy.cfg
      register: haproxy_config_file

    - name: "{{ action }} ingress section in haproxy"
      ansible.builtin.include_tasks: "{{ action }}-ingress-haproxy.yaml"

    - name: Restart Haproxy to let changes take effect
      ansible.builtin.systemd:
        enabled: yes
        state: restarted
        name: haproxy

