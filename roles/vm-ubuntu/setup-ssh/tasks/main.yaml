# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- name: Configure ssh connectivity for Ansible host
  delegate_to: localhost
  become_user: root
  vars:
    lock_file: "{{ _work_dir }}/ssh.lock"
  block:
    - name: Ensure that file is not locked
      ansible.builtin.wait_for:
        path: "{{ lock_file }}"
        state: absent
        timeout: 5
      ignore_errors: yes

    - name: Acquiring lock (Create lock file)
      file:
        path: "{{ lock_file }}"
        state: touch

    - name: Checking ssh port availability
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        msg: Timeout waiting for ssh port availability. You may want to set a higher timeout value.

    - name: Remove known_host entries from Ansible host (if exist)
      known_hosts:
        path: /root/.ssh/known_hosts
        name: "{{ ansible_host }}"
        state: absent

    - name: Register servers as known hosts to Ansible hosts
      shell: |
              ssh-keyscan -H {{ ansible_host }} >> /root/.ssh/known_hosts

    - name: Releasing lock (lock file)
      file:
        path: "{{ lock_file }}"
        state: absent
