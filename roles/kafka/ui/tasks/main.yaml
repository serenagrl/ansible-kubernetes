# Author: Serena Yeoh
# Co-Author: Jaryl Lan
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

- name: Add kafka portal DNS entries to /etc/hosts
  become_user: root
  delegate_to: "{{ item }}"
  ansible.builtin.lineinfile:
    path: /etc/hosts
    insertafter: "127.0.0.1 localhost"
    line: "{{ _kube.cluster.address }} kafka.{{ _kube.cluster.domain }}"
  loop: "{{ fact_active_hosts + ['localhost'] }}"
  ignore_errors: yes
  ignore_unreachable: yes
  when: not _kube.cluster.use_dns_server

- name: Register CNAME record to DNS server
  include_role:
    name: "infrastructure/dns/register"
  vars:
    in_server_name: "{{ _kube.cluster.name }}"
    in_cname: "kafka"
    in_type: "CNAME"
  when: _kube.cluster.use_dns_server

- name: Install kafka-ui
  block:
    - name: Add kafka-ui chart repo
      kubernetes.core.helm_repository:
        name: kafka-ui
        repo_url: "https://provectus.github.io/kafka-ui-charts"

    - ansible.builtin.include_tasks: ./tasks/task-create-certificate.yaml
      vars:
        name: kafka-ui
        certificate_template: "{{ CERTIFICATE_TEMPLATE }}"

    # Notes: Uses own domain names.
    - name: Setup ingress
      ansible.builtin.include_tasks: "{{ INGRESS_SETUP }}"

    - name: Deploying kafka-ui
      vars:
        ingress_name: "{{ ingress_class.resources[0].metadata.name }}"
        version: "{% if kafka.ui.version is defined and kafka.ui.version and kafka.ui.version != 'latest' %}{{ kafka.ui.version }}{% endif %}"
        has_issuer: issuer_status.stdout == "Ready"
      kubernetes.core.helm:
        name: kafka-ui
        atomic: yes
        chart_ref: kafka-ui/kafka-ui
        chart_version: "{{ version }}"
        namespace: "{{ kafka.namespace }}"
        create_namespace: yes
        values: "{{ VALUES_FILE }}"
        timeout: 10m0s
        wait: yes