# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

- name: Install strimzi kafka cli and pre-requisites on Ansible host
  delegate_to: localhost
  become_user: root
  block:
    - name: Installing dependency packages (may take a while)
      ansible.builtin.apt:
        pkg:
          - python3-pip
          - jq
        state: latest
        update_cache: yes

    - name: Install strimzi kafka cli
      vars:
        has_version_specified: "{{ (strimzi.cli.version is defined and strimzi.cli.version and strimzi.cli.version != 'latest') | bool }}"
        release: "{{ has_version_specified | ternary(strimzi.cli.version, release_tag.stdout.replace('alpha', 'a')) }}"
      block:
        - name: Get latest strimzi kafka cli version
          ansible.builtin.shell: |
            curl -s https://api.github.com/repos/SystemCraftsman/strimzi-kafka-cli/releases | jq '[.[]] | sort_by(.tag_name) | reverse | first' | grep tag_name | cut -d '"' -f 4
          register: release_tag
          when: not has_version_specified

        # Note: The break_system_packages property in ansible.builtin.pip module requires ansible 2.17.1
        - name: Installing strimzi kafka cli on Ansible host
          vars:
            pip_args: "{{ (hostvars['localhost'].ansible_distribution_version|float >= 24.04) | ternary('--break-system-packages', '') }}"
          shell: |
            pip install strimzi-kafka-cli=={{ release }} -I {{ pip_args }}