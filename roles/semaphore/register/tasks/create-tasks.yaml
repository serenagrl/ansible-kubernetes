- name: Create Default Setup tasks
  ansible.builtin.uri:
    url: "{{ SEMAPHORE_URL }}/project/{{ SEMAPHORE_PROJECT_ID }}/templates"
    method: POST
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ SEMAPHORE_ACCESS_TOKEN }}"
    body_format: json
    body: |
      {
        "project_id": {{ SEMAPHORE_PROJECT_ID }},
        "inventory_id": {{ item.inv_id | default(SEMAPHORE_DEFAULT_INVENTORY_ID) }},
        "repository_id": {{ SEMAPHORE_REPO_ID }},
        "environment_id": {{ (environment_response | community.general.json_query('json[?name==`' + item.env_name + '`].id')).0 }},
        "view_id": null,
        "name": "{{ item.name }}",
        "playbook": "{{ item.playbook }}",
        "description": "{{ item.desc }}",
        "arguments": null,
        "allow_override_args_in_task": false,
        "limit": "",
        "suppress_success_alerts": true,
        "survey_vars": {{ item.surveys | default([]) }}
      }
    status_code: 201 # Created
  loop:
    - { name: "1. Setup Infrastructure", env_name: "Setup Infrastructure", surveys: "{{ SETUP_INFRA_SURVEYS + PROVISION_VM_SURVEYS }}",
        playbook: "{{ PLAYBOOKS.SETUP_INFRASTRUCTURE }}", desc: "Setup and configure supporting infrastructure services servers." }
    - { name: "2. Setup Kubernetes", env_name: "Setup Infrastructure", surveys: "{{ SETUP_KUBERNETES_SURVEYS + PROVISION_VM_SURVEYS }}",
        playbook: "{{ PLAYBOOKS.SETUP_KUBERNETES }}", desc: "Setup a Kubernetes Cluster complete with control planes and worker nodes. Optionally, provisions VM for them." }
    - { name: "3. Setup Basic Add-Ons", env_name: "Setup Basic Add-Ons",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs basic kubernetes components. (Cert-Manager, Ingress, Dashboard, Monitoring, Metrics Server)" }
    - { name: "4. Setup CSI", env_name: "Setup Add-On - CSI", surveys: "{{ SETUP_CSI_SURVEYS }}",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs the CSI." }
    - { name: "Setup Semaphore Project", env_name: "Setup Semaphore Project",
        inv_id: "{{ SEMAPHORE_PROJECT_INVENTORY_ID }}",
        playbook: "{{ PLAYBOOKS.SETUP_SEMAPHORE_PROJECT }}", desc: "Creates a new ansible-kubernetes semaphore project. (Suitable for testing new playbook updates)." }
      # Miscellaneous
    - { name: "Setup Add-On - DevOps (Gitlab)", env_name: "Setup Add-On - DevOps (Gitlab)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Gitlab and Gitlab Runner. (Also installs Minio)." }
    - { name: "Setup Add-On - DevOps (Sonarqube)", env_name: "Setup Add-On - DevOps (Sonarqube)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Sonarqube." }
    - { name: "Setup Add-On - DevOps (Harbor)", env_name: "Setup Add-On - DevOps (Harbor)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Harbor container registry." }
    - { name: "Setup Add-On - DevOps (ArgoCD)", env_name: "Setup Add-On - DevOps (ArgoCD)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs ArgoCD." }
    - { name: "Setup Add-On - RabbitMQ", env_name: "Setup Add-On - RabbitMQ",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs RabbitMQ Operator and creates a RabbitMQ Cluster." }
    - { name: "Setup Add-On - Redis", env_name: "Setup Add-On - Redis",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Creates a Redis cluster or Sentinel." }
    - { name: "Setup Add-On - Velero", env_name: "Setup Add-On - Velero",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Velero." }
    - { name: "Setup Add-On - Logging (Elastic Stack)", env_name: "Setup Add-On - Logging (Elastic Stack)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Logging components. (Elasticsearch, Kibana, Fluentd)" }
    - { name: "Setup Add-On - Logging (Fluentd)", env_name: "Setup Add-On - Logging (Fluentd)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Logging components. (Elasticsearch, Kibana, Fluentd)" }
    - { name: "Setup Add-On - Istio", env_name: "Setup Add-On - Istio",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Istio" }
    - { name: "Setup Add-On - MSSQL Server", env_name: "Setup Add-On - MSSQL Server",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Microsoft SQL Server." }
    - { name: "Setup Add-On - AWX", env_name: "Setup Add-On - AWX",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs AWX and register the environment for use." }
    - { name: "Setup Add-On - Kafka", env_name: "Setup Add-On - Kafka",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Strimzi and creates a Kafka cluster." }
    - { name: "Setup Add-On - Knative", env_name: "Setup Add-On - Knative",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs knative." }
    - { name: "Setup Add-On - Goldilocks", env_name: "Setup Add-On - Goldilocks",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs goldilocks." }
    - { name: "Setup Add-On - Keycloak", env_name: "Setup Add-On - Keycloak",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs keycloak." }
    - { name: "Setup Add-On - Tracing", env_name: "Setup Add-On - Tracing",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs tracing." }
    - { name: "Setup Add-On - Logging (Loki)", env_name: "Setup Add-On - Logging (Loki)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs loki." }
    - { name: "Setup Add-On - DevOps (Tekton)", env_name: "Setup Add-On - DevOps (Tekton)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs tekton." }
    - { name: "Setup Add-On - DevOps (Minio)", env_name: "Setup Add-On - DevOps (Minio)",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs minio." }
    - { name: "Setup Add-On - MetalLB", env_name: "Setup Add-On - MetalLB",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs MetalLB." }
    - { name: "Setup Add-On - Trivy", env_name: "Setup Add-On - Trivy",
        playbook: "{{ PLAYBOOKS.SETUP_ADD_ONS }}", desc: "Installs Trivy." }