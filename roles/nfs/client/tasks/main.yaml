# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- include_vars: ../../vars/main.yaml

- name: Installing nfs client package
  apt:
    pkg:
      - nfs-common
    state: latest
    update_cache: true

- delegate_to: "{{ groups['nfs_server'][0] }}"
  become_user: root
  vars:
    lock_file: "/tmp/nfs.lock"
  block:
    - name: Ensure that file is not locked
      ansible.builtin.wait_for:
        path: "{{ lock_file }}"
        state: absent
        timeout: 3
      ignore_errors: yes

    - name: Acquiring lock (Create lock file)
      file:
        path: "{{ lock_file }}"
        state: touch

    - name: Export shared directory to kubernetes cluster nodes
      lineinfile:
        path: /etc/exports
        line: "{{ nfs.shared }} {{ ansible_host }}(rw,no_subtree_check,no_root_squash)"

    - name: Enable nfs
      shell: |
              sudo exportfs -ar

    - name: Releasing lock (lock file)
      file:
        path: "{{ lock_file }}"
        state: absent
