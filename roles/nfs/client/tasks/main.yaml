# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- ansible.builtin.include_vars: ../../vars/main.yaml

- name: Installing nfs client package
  ansible.builtin.apt:
    pkg:
      - nfs-common
    state: latest
    update_cache: true

- name: Export shared directory to kubernetes cluster nodes
  delegate_to: "{{ groups['nfs_server'][0] }}"
  become_user: root
  ansible.builtin.shell: |
    (
        flock -x 9

        mount | grep "{{ nfs.shared }} {{ ansible_host }}"
        if [ $? -eq "1" ]
        then
          echo "{{ nfs.shared }} {{ ansible_host }}(rw,no_subtree_check,no_root_squash)" >> /etc/exports
        fi
    ) 9>/tmp/nfs.lock
