- include_tasks: ./tasks/task-create-certificate.yaml
  vars:
    name: harbor
    certificate_name: "nginx-cert"
    secret_name: "nginx-tls"
    certificate_template: "{{ CERTIFICATE_TEMPLATE }}"

- name: Get ingress class
  kubernetes.core.k8s_info:
    kind: IngressClass
  register: ingress_class

- name: Deploying harbor
  vars:
    ingress_name: "{{ ingress_class.resources[0].metadata.name }}" 
    version: "{% if release_version is defined and release_version and release_version != 'latest' %}{{ release_version }}{% endif %}"
  kubernetes.core.helm:
    name: harbor
    atomic: yes
    chart_ref: harbor/harbor
    chart_version: "{{ version }}"
    namespace: harbor-system
    create_namespace: yes
    values: "{{ NGINX_VALUES_FILE }}"
    timeout: 10m0s
    wait: yes