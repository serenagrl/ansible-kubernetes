# Author: Serena Yeoh
# Co-Author: Jaryl Lan
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

- name: Install velero cli to ansible controller
  delegate_to: localhost
  vars:
    repo_path: vmware-tanzu/velero 
    release: "{% if velero_cli.version is defined and velero_cli.version and velero_cli.version != 'latest' %}v{{ velero_cli.version }}{% else %}{{ release_tag.stdout }}{% endif %}"
    tar_file: velero-{{ release }}-linux-amd64.tar.gz
    cli_dir: "{{ _work_dir }}/velero-{{ release }}-linux-amd64"
  block:
    - name: Get latest velero release tag
      shell: |
          curl -s "https://api.github.com/repos/{{ repo_path }}/releases/latest" | grep tag_name | cut -d '"' -f 4
      register: release_tag
      when: velero_cli.version is undefined or not velero_cli.version or velero_cli.version == "latest"

    - name: Downloading and extracting velero cli
      ansible.builtin.unarchive:
        src: "https://github.com/{{ repo_path }}/releases/download/{{ release }}/{{ tar_file }}"
        dest: "{{ _work_dir }}"
        remote_src: yes

    - name: Move velero cli to /usr/local/bin 
      shell: mv {{ cli_dir }}/velero /usr/local/bin

    - name: Cleanup files
      file:
        path: "{{ cli_dir }}"
        state: absent
      when: _cleanup