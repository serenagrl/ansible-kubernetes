# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- name: Get control-plane join command
  delegate_to: "{{ groups['primary_control_plane'][0] }}"
  ansible.builtin.shell: echo $(kubeadm token create --print-join-command) --control-plane --certificate-key $(kubeadm init phase upload-certs --upload-certs | grep -vw -e upload-certs)
  register: join_command
  run_once: yes

- name: Join secondary control planes
  ansible.builtin.shell: |
    {{ join_command.stdout }}

- become_user: "{{ _kube.user }}"
  delegate_to: "{{ groups['primary_control_plane'][0] }}"
  name: Wait for calico to be ready
  ansible.builtin.shell: |
    kubectl wait --for=condition=Available=True tigerastatuses.operator.tigera.io calico
    kubectl wait --for=condition=Available=True tigerastatuses.operator.tigera.io apiserver

- ansible.builtin.include_role:
    name: kubernetes/control-plane