# Author: Serena Yeoh
#
# Disclaimer: 
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

- delegate_to: "{{ item }}"
  become_user: root
  block:
    - name: Register control plane to HAProxy load-balancers
      ansible.builtin.lineinfile:
        path: /etc/haproxy/haproxy.cfg
        insertafter: "default-server"
        line: |2-
             server {{ inventory_hostname }} {{ ansible_host }}:6443
        create: yes

    - name: Restart Haproxy to let changes take effect
      ansible.builtin.systemd:
        enabled: yes
        state: restarted
        name: haproxy