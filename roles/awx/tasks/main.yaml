# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- name: Get ingress class
  kubernetes.core.k8s_info:
    kind: IngressClass
  register: ingress_class

- name: Create a awx namespace
  kubernetes.core.k8s:
    name: awx
    api_version: v1
    kind: Namespace
    state: present

- name: Create Ingress TLS Certificate
  kubernetes.core.k8s:
    definition: "{{ CERTIFICATE_TEMPLATE }}"

- name: Install AWX
  block:
    - name: Deploy AWX
      vars:
        ingress_name: "{{ ingress_class.resources[0].metadata.name }}"    
        version: "{% if release_version is defined and release_version and release_version != 'latest' %}{{ release_version }}{% endif %}"
      kubernetes.core.helm:
        name: awx
        atomic: yes
        chart_repo_url: "https://ansible.github.io/awx-operator"
        chart_ref: awx-operator
        chart_version: "{{ version }}"
        namespace: awx
        create_namespace: yes
        values: "{{ VALUES_FILE }}"
        wait: yes

    - name: Waiting for AWX deployments to be ready
      shell: |
          for d in $(kubectl -n awx get deployment -o json | jq -r .items[].metadata.name); do kubectl rollout status -n awx deployment/$d; done;
          for d in $(kubectl -n awx get statefulset -o json | jq -r .items[].metadata.name); do kubectl rollout status -n awx statefulset/$d; done;

    - name: Waiting for AWX controller host to be up
      uri:
        url: "{{ AWX_HOST }}"
      register: result
      until: result.status == 200
      retries: 20
      delay: 30

    - import_tasks: ./tasks/task-get-secret.yaml
      vars:
        name: "awx portal password"
        command: "kubectl get secret -n awx awx-admin-password -o jsonpath='{.data.password}'"
        filename: "awx_password"

- import_tasks: register.yaml
  when: auto_register