# Author: Serena Yeoh
# Co-Author: Jaryl Lan
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

- name: Configure vault
  vars:
    vault_leader: "vault-0"
  block:
    - name: Initialize vault
      shell: kubectl exec -n vault "{{ vault_leader }}" -- vault operator init -key-shares="{{ vault.unseal.manual.key_shares }}" -key-threshold="{{ vault.unseal.manual.key_threshold }}"  -address="https://{{ vault_leader }}.vault-internal:8200" -ca-cert="/vault/userconfig/vault-cluster-tls/ca.crt"
      register: key_result

    - name: Store key into file on Ansible controller host
      delegate_to: localhost
      become_user: root
      vars:
        keys_regex: 'Unseal Key.*\n(?:^.+\n)*'
        keys: "{{ key_result.stdout | regex_search(keys_regex, multiline=True) }}"
        token_regex: 'Initial Root Token:.*\n(?:^.+\n)*'
        token: "{{ key_result.stdout | regex_search(token_regex) }}"
      ansible.builtin.blockinfile:
        path: "{{ temp_dir }}/{{ kube.cluster.name }}-credentials"
        marker: "##### {mark} Vault #####"
        block: |
          {{ keys }}{{ token }}
        create: yes

    - name: Unseal {{ vault_leader }}
      vars:
        key: "{{ key_result.stdout | regex_search('Unseal Key ' + item|string + ': (.+)', '\\1') | first }}"
      ansible.builtin.shell: kubectl exec -n vault "{{ vault_leader }}" -- vault operator unseal -address="https://{{ vault_leader }}.vault-internal:8200" -ca-cert="/vault/userconfig/vault-cluster-tls/ca.crt" {{ key }}
      loop: "{{ range(1, vault.unseal.manual.key_threshold + 1) }}"

    - name: Join node to raft cluster
      vars:
        vault_follower: "vault-{{ vault_index }}"
      ansible.builtin.include_tasks: "join-raft-cluster.yaml"
      loop: "{{ range(1, fact_active_hosts|length) }}"
      loop_control:
        loop_var: vault_index