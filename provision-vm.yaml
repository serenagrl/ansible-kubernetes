# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#
- name: <<<<< Creates Hyper-V Virtual Machines >>>>>
  hosts: kubernetes_cluster
  gather_facts: no

  tasks:
    - name: Run on Winrm
      block:
        - name: Provisioning Hyper-V Virtual Machines
          vars:
            vhd_disk: "{{ _vm.dir.windows}}\\{{ inventory_hostname }}\\Virtual Hard Disks\\{{ inventory_hostname }}.vhdx"
          ansible.windows.win_powershell:
            script: |
              New-VM -Name {{ inventory_hostname }} -Generation 2 -MemoryStartupBytes {{ spec.ram_size }} -SwitchName {{ _vm.switch }} -Path "{{ _vm.dir.windows }}" -BootDevice CD
              New-VHD -Path "{{ vhd_disk }}" -SizeBytes {{ spec.disk_size }} -Dynamic
              Add-VMHardDiskDrive {{ inventory_hostname }} -Path "{{ vhd_disk }}"
              Set-VMDvdDrive {{ inventory_hostname }} -Path "{{ _vm.iso.windows }}\\{{ inventory_hostname }}-ubuntu.iso"
              Set-VMProcessor {{ inventory_hostname }} -Count {{ spec.v_cpu }}
              Set-VMFirmware -VMName {{ inventory_hostname }} -EnableSecureBoot Off
              Set-VMMemory {{ inventory_hostname }} -MinimumBytes {{ spec.min_ram_size }}
              Start-VM {{ inventory_hostname }}

        - name: Waiting for ubuntu installations to complete
          ansible.windows.win_powershell:
            script: |
              Wait-VM -Name {{ inventory_hostname }} -For Reboot

        - name: Wait for Virtual Machines to be ready
          ansible.windows.win_powershell:
            script: |
              Wait-VM -Name {{ inventory_hostname }} -For Heartbeat

        - name: Removing .iso files to save space
          ansible.windows.win_powershell:
            script: |
              rm {{ inventory_hostname }}-ubuntu.iso

            chdir: "{{ _vm.iso.windows }}"
          when: _vm.cleanup

      delegate_to: winrm_host

