# Note: Setup NFS before enabling the csi-nfs role.
- import_playbook: setup-nfs.yaml

- name: Install Kubernetes add-on components
  hosts: primary_control_plane[0]
  become_user: "{{ _kube.user }}"
  gather_facts: no

  roles:
    - role: metallb
    - role: cert-manager
    - role: ingress
    - role: dashboard
    # - role: monitoring
    - role: metrics-server
    - role: csi/nfs
    # - role: csi/rook-ceph
    # - role: devops/minio
    # - role: devops/gitlab
    # - role: devops/gitlab-runner
    # - role: devops/sonarqube
    # - role: devops/harbor
    # - role: devops/argocd
    # - role: logging/elastic-stack
    # - role: logging/fluentd
    # - role: awx/operator
    # - role: awx/register
    # - role: istio
    # - role: rabbitmq/operator
    # - role: rabbitmq/cluster
    # - role: database/mssql
    # - role: velero

# Create checkpoints for safety reasons. You can delete the checkpoints later.
- hosts: kubernetes_cluster
  gather_facts: no

  tasks:
    - import_tasks: ./tasks/task-checkpoint-vm.yaml
      vars:
        checkpoint_name: "Components installed."
      when: _checkpoint
