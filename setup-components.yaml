# Author: Serena Yeoh
#
# Disclaimer:
# This playbook was written based on my self-learning and may not follow certain
# best practices or work properly in your environment. Use it at your own risk.
#

# Install nfs client to all kubernetes nodes.
# Note: This is a pre-requisite if you want to install the csi/nfs role.
- name: Configure NFS Clients
  hosts: kubernetes_cluster
  gather_facts: no

  roles:
    - role: nfs/client
      when: "'csi/nfs' in (_kube.add_ons | map(attribute='name') | list)"

- name: Install Kubernetes add-on components
  hosts: primary_control_plane[0]
  become_user: "{{ _kube.user }}"
  gather_facts: no

  tasks:
    - name: Install Kubernetes add-on components
      ansible.builtin.include_tasks: tasks/task-run-role.yaml
      loop: "{{ _kube.add_ons }}"
      loop_control:
        loop_var: role

# Create checkpoints for safety reasons. You can delete the checkpoints later.
- hosts: kubernetes_control_planes
  gather_facts: no

  tasks:
    - ansible.builtin.import_tasks: ./tasks/task-checkpoint-vm.yaml
      vars:
        checkpoint_name: "Components installed."
      when: _checkpoint
